<!DOCTYPE html>
<html>
<head>
    <title>ARSI Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { background: #000; color: white; text-align: center; font-family: sans-serif; }
        #video-container { width: 90%; max-width: 400px; margin: 20px auto; border: 2px solid #ff9800; border-radius: 20px; overflow: hidden; }
        video { width: 100%; }
        .status { font-size: 1.2rem; margin-top: 20px; color: #ff9800; }
    </style>
</head>
<body>
    <h1>SCAN WALL QR</h1>
    <div id="video-container"><video id="preview" playsinline></video></div>
    <div id="status" class="status">Initializing Camera...</div>

    <script>
        const video = document.getElementById('preview');
        const statusDiv = document.getElementById('status');
        const RENDER_URL = "https://arsi-bridge.onrender.com";
        
        // Get token from the URL sent by your laptop
        const urlParams = new URLSearchParams(window.location.search);
        const activeToken = urlParams.get('token');

        if (!activeToken) {
            statusDiv.innerText = "Error: No Token. Please login at the gym.";
        } else {
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    statusDiv.innerText = "Align QR Code '1234' to enter";
                    requestAnimationFrame(tick);
                });
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);

                if (code && code.data === "1234") {
                    sendToBridge();
                    return;
                }
            }
            requestAnimationFrame(tick);
        }

        function sendToBridge() {
            statusDiv.innerText = "Verifying Access...";
            fetch(`${RENDER_URL}/api/mobile-scan-wall`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token: activeToken, qr_content: "1234" })
            })
            .then(res => res.json())
            .then(data => {
                statusDiv.style.color = "#00ff00";
                statusDiv.innerText = "✅ ACCESS GRANTED!";
                setTimeout(() => { window.location.href = "about:blank"; }, 2000);
            })
            .catch(err => {
                statusDiv.style.color = "#ff0000";
                statusDiv.innerText = "❌ ACCESS DENIED";
            });
        }
    </script>
</body>
</html>
