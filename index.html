<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARSI GATE | QR SCANNER</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; margin: 0; text-align: center; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; }
        .container { padding: 20px; }
        .status-box { margin-top: 20px; padding: 15px; border-radius: 10px; background: #1e1e1e; border: 1px solid #333; }
        #result { font-size: 1.5rem; font-weight: bold; color: #4ade80; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>ARSI GATE SCANNER</h2>
    <p>Align Member QR/Token within the frame</p>
    
    <div id="reader"></div>

    <div class="status-box">
        <div id="result">Ready to Scan</div>
        <div id="debug" style="font-size: 0.8rem; color: #666;">Waiting for camera...</div>
    </div>
</div>

<script>
    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    // Start the camera
    html5QrCode.start(
        { facingMode: "environment" }, // Use back camera
        config,
        (decodedText) => {
            // Logic when a QR/Token is detected
            processScan(decodedText);
        },
        (errorMessage) => {
            // Keep scanning even if there's a minor error
        }
    ).catch(err => {
        document.getElementById('debug').innerHTML = "Camera Error: " + err;
    });

    function processScan(token) {
        // Stop scanning temporarily so it doesn't spam requests
        html5QrCode.pause();
        
        document.getElementById('result').innerHTML = "Scanned: " + token;
        document.getElementById('debug').innerHTML = "Sending to server...";

        // Send the scanned token to your local Python server
        // Use '1234' as the secret_token for your universal logic
        fetch('http://YOUR_LOCAL_IP:5000/api/mobile-qr-check-in', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                member_id: "scanner_input", // We identify this as a scanner scan
                secret_token: token         // The code read by the camera
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'granted') {
                document.getElementById('result').innerHTML = "ACCESS GRANTED";
                document.getElementById('result').style.color = "#4ade80";
            } else {
                document.getElementById('result').innerHTML = "DENIED: " + data.message;
                document.getElementById('result').style.color = "#f87171";
            }
            
            // Resume camera after 3 seconds
            setTimeout(() => {
                document.getElementById('result').innerHTML = "Ready to Scan";
                document.getElementById('result').style.color = "#4ade80";
                html5QrCode.resume();
            }, 3000);
        })
        .catch(err => {
            alert("Local Server Not Found! Check IP/Network.");
            html5QrCode.resume();
        });
    }
</script>

</body>
</html>
