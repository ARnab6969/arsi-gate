<script>

const API = "https://YOUR-RENDER-APP.onrender.com/api/mobile-qr-check-in";

let wallVerified = false;
let scannerRunning = true;

function showMessage(msg, type){
    const box = document.getElementById("result");
    box.className = "result " + type;
    box.innerText = msg;
}

function resetScanner(){
    wallVerified = false;
    showMessage("", "");
    scanner.resume();
}

function onScanSuccess(decodedText){

    if(!scannerRunning) return;

    scannerRunning = false;  // prevent multiple scans
    scanner.pause();

    // STEP 1 — WALL QR
    if(!wallVerified){

        if(decodedText === "1234"){
            wallVerified = true;
            showMessage("Wall Verified ✅ Now Scan Member QR", "granted");

            setTimeout(()=>{
                scannerRunning = true;
                scanner.resume();
            },1500);

        } else {
            showMessage("Invalid Wall QR ❌", "denied");

            setTimeout(()=>{
                scannerRunning = true;
                scanner.resume();
            },2000);
        }

        return;
    }

    // STEP 2 — MEMBER QR
    fetch(API,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            wall_code:"1234",
            qr_token:decodedText
        })
    })
    .then(res=>res.json())
    .then(data=>{

        if(data.status==="granted"){
            showMessage("ACCESS GRANTED ✅", "granted");
        } else {
            showMessage("ACCESS DENIED ❌", "denied");
        }

        setTimeout(()=>{
            scannerRunning = true;
            resetScanner();
        },3000);
    })
    .catch(()=>{
        showMessage("SERVER ERROR ❌", "denied");

        setTimeout(()=>{
            scannerRunning = true;
            resetScanner();
        },3000);
    });
}

const scanner = new Html5Qrcode("reader");

scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
);

</script>
