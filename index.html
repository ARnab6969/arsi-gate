<script>
    const video = document.getElementById('preview');
    const RENDER_BRIDGE_URL = "https://arsi-bridge.onrender.com";
    
    const urlParams = new URLSearchParams(window.location.search);
    const activeToken = urlParams.get('token');

    // ... (keep the loading logic from before) ...

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                console.log("Found QR:", code.data);
                // CHECK FOR 1234
                if (code.data === "1234") {
                    sendToBridge(code.data);
                    return; // Stop scanning once found
                } else {
                    document.getElementById('status-text').innerText = "Invalid QR: " + code.data;
                }
            }
        }
        requestAnimationFrame(tick);
    }

    function sendToBridge(wallContent) {
        document.getElementById('status-text').innerText = "Sending to Bridge...";
        
        fetch(`${RENDER_BRIDGE_URL}/api/mobile-scan-wall`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                token: activeToken, 
                qr_content: wallContent 
            })
        })
        .then(res => res.json())
        .then(data => {
            alert("Success: " + data.message);
            document.getElementById('status-text').innerText = "✅ Door Unlocked!";
        })
        .catch(err => {
            alert("Bridge Error: " + err);
            document.getElementById('status-text').innerText = "❌ Connection Failed";
        });
    }
</script>
