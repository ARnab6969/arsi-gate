<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arsi Fitness Entry</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
    margin:0;
    background:#111;
    color:white;
    font-family:Arial, sans-serif;
    text-align:center;
}

.container{
    padding:20px;
}

h1{
    color:#00ff99;
}

#reader{
    margin-top:20px;
}

.result{
    margin-top:20px;
    font-size:22px;
    font-weight:bold;
}

.granted{
    color:#00ff99;
}

.denied{
    color:#ff4d4d;
}
</style>
</head>

<body>

<div class="container">
    <h1>ARSI FITNESS GYM</h1>
    <p>Scan Wall QR → Then Member QR</p>

    <div id="reader"></div>
    <div id="result" class="result"></div>
</div>

<script>

const API = "https://YOUR-RENDER-URL.onrender.com/api/mobile-qr-check-in";

let wallVerified = false;

function resetScanner(){
    document.getElementById("result").innerText = "";
    wallVerified = false;
}

function showResult(message, type){

    const resultBox = document.getElementById("result");
    resultBox.className = "result " + type;
    resultBox.innerText = message;

    // After 3 seconds return to home screen
    setTimeout(() => {
        resetScanner();
    }, 3000);
}

function onScanSuccess(decodedText){

    // Step 1: Verify Wall QR
    if(!wallVerified){

        if(decodedText === "1234"){
            wallVerified = true;
            showResult("Wall Verified ✅ Now Scan Member QR", "granted");
        } else {
            showResult("Invalid Wall QR ❌", "denied");
        }
        return;
    }

    // Step 2: Send Member QR
    fetch(API,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            wall_code: "1234",
            qr_token: decodedText
        })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.status === "granted"){
            showResult("ACCESS GRANTED ✅", "granted");
        } else {
            showResult("ACCESS DENIED ❌", "denied");
        }
        wallVerified = false;
    })
    .catch(()=>{
        showResult("SERVER ERROR ❌", "denied");
        wallVerified = false;
    });
}

const scanner = new Html5Qrcode("reader");

scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
);

</script>

</body>
</html>
